name: Production Database Migration

# Trigger: 
# 1. Run on push to main/master IF sql files change
# 2. Allow manual trigger (workflow_dispatch) for debugging
on:
  push:
    branches:
      - main
      - master
    paths:
      - 'sql/**'
  workflow_dispatch:

jobs:
  flyway-migrate:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout Code (Make sure V2/V3 files are actually downloaded)
      - name: Checkout Code
        uses: actions/checkout@v3

      # Step 2: Connect to Tailscale (VPN to reach your laptop/server)
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      # Step 3: Debug Info (See what Flyway sees before running)
      # This prints a table of migrations (PENDING, IGNORED, SUCCESS) to the logs.
      # Check this log if V2 is skipped!
      - name: Flyway Info (Debug)
        uses: docker://flyway/flyway:11
        with:
          args: >-
            -url=${{ secrets.DB_URL }}
            -user=${{ secrets.DB_USER }}
            -password=${{ secrets.DB_PASSWORD }}
            -schemas=${{ secrets.FLYWAY_SCHEMA }}
            -locations=filesystem:sql
            info

      # Step 4: Run Migrate (The actual execution)
      - name: Flyway Migrate
        uses: docker://flyway/flyway:11
        with:
          args: >-
            -url=${{ secrets.DB_URL }}
            -user=${{ secrets.DB_USER }}
            -password=${{ secrets.DB_PASSWORD }}
            -schemas=${{ secrets.FLYWAY_SCHEMA }}
            -createSchemas=true
            -locations=filesystem:sql
            -baselineOnMigrate=true
            -baselineVersion=1
            -outOfOrder=true
            migrate