name: Production Database Migration

# Trigger: Run this only when code is pushed to the 'main' branch
on:
  push:
    branches:
      - main
      - master
    paths:
      - 'sql/**' # Only run if SQL files changed

jobs:
  flyway-migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # === NEW STEP: Connect Runner to Tailscale ===
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci
          
     # Step A: Baseline (Marks V1 as done if history is missing)
      - name: Flyway Baseline
        uses: docker://flyway/flyway:11
        with:
          args: >-
            -url=${{ secrets.DB_URL }} 
            -user=${{ secrets.DB_USER }} 
            -password=${{ secrets.DB_PASSWORD }} 
            -schemas=${{secrets.FLYWAY_SCHEMA}} 
            -createSchemas=true 
            -baselineVersion=1
            baseline

      # Step B: Migrate (Runs V2, V3...)
      - name: Flyway Migrate
        uses: docker://flyway/flyway:11
        with:
          args: >-
            -url=${{ secrets.DB_URL }} 
            -user=${{ secrets.DB_USER }} 
            -password=${{ secrets.DB_PASSWORD }} 
            -schemas=${{secrets.FLYWAY_SCHEMA}} 
            -createSchemas=true 
            -baselineOnMigrate=true
            -baselineVersion=1
            migrate
