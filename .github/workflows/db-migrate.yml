name: Production Database Migration

# Trigger: Run this only when code is pushed to the 'main' branch
on:
  push:
    branches:
      - main
      - master
    paths:
      - 'sql/**' # Only run if SQL files changed

jobs:
  flyway-migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # === NEW STEP: Connect Runner to Tailscale ===
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci
          
      # === EXISTING STEP: Run Flyway ===
      - name: Flyway Migrate
        uses: docker://flyway/flyway:11
        with:
          # Now the runner can reach "100.x.x.x" because it joined the VPN!
          args: >-
            -url=${{ secrets.DB_URL }}
            -user=${{ secrets.DB_USER }}
            -password=${{ secrets.DB_PASSWORD }}
            -locations=filesystem:sql
            -schemas=${{ secrets.FLYWAY_SCHEMA }} 
            -createSchemas=true 
            -baselineOnMigrate=true
            -baselineVersion=1
            migrate
